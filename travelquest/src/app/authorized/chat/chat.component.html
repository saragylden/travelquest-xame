<div *ngIf="currentUserUID">
  <div class="user-info-box">
    <span class="user-name">{{ otherUserName }}</span>
    <button
      mat-icon-button
      class="user-icon-button"
      (click)="callMeetupVerification()"
      [disabled]="isRequesting || isRequestPending"
      *ngIf="currentConversationId && otherUserId && otherUserName"
    >
      <mat-icon>group_add</mat-icon>
    </button>
  </div>

  <div *ngIf="currentConversationId; else noConversation">
    <div *ngIf="loadingMessages" class="loading-state">
      <p>Loading messages...</p>
    </div>

    <!-- Message List -->
    <div *ngIf="!loadingMessages" #messageContainer class="message-container">
      <div
        *ngFor="let message of messages$ | async"
        class="message"
        [ngClass]="{
          'sent-message': message.user === currentUserUID,
          'received-message': message.user !== currentUserUID
        }"
      >
        <div class="message-header">
          <strong>{{ message.user }}:</strong>
        </div>
        <div class="message-content">
          {{ message.text }}

          <!-- Show "Accept" and "Decline" buttons for meetup verification message -->
          <div *ngIf="message.text.includes('Did you meet')">
            <button (click)="openMeetupVerification(message)">Accept</button>
            <button (click)="openMeetupVerification(message)">Decline</button>
          </div>
        </div>
        <div class="message-footer">
          <span class="timestamp">{{
            message.timestamp.toDate() | date : "short"
          }}</span>
        </div>
      </div>
    </div>

    <!-- Display Pending Meetup Verification Requests -->
    <div *ngIf="verificationRequests.length > 0" class="verification-requests">
      <div
        *ngFor="let request of verificationRequests"
        class="verification-request"
      >
        <div class="verification-message">
          Have you met {{ request.senderUID || "Unknown Sender" }}
        </div>
        <div class="verification-actions">
          <button
            class="accept-button"
            (click)="handleResponse(request, 'accept')"
          >
            Accept
          </button>
          <button
            class="decline-button"
            (click)="handleResponse(request, 'decline')"
          >
            Decline
          </button>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="message-input">
      <textarea
        [(ngModel)]="newMessage"
        placeholder="Type a message..."
        rows="3"
      ></textarea>
      <button (click)="sendMessage()" [disabled]="!newMessage.trim()">
        Send
      </button>
    </div>
  </div>

  <!-- No Conversation State -->
  <ng-template #noConversation>
    <p class="no-conversation-message">
      No conversation exists yet. You can start chatting by sending a message!
    </p>

    <!-- Message Input -->
    <div class="message-input">
      <textarea
        [(ngModel)]="newMessage"
        placeholder="Type a message..."
        rows="3"
      ></textarea>
      <button (click)="sendMessage()" [disabled]="!newMessage.trim()">
        Send
      </button>
    </div>
  </ng-template>
</div>

<!-- Error State -->
<div *ngIf="!currentUserUID" class="error">
  <p>You must log in to view or send messages.</p>
</div>
